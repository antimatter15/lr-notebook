{% extends "layout.html" %}
{% from "macros/projects.html" import project_header_links %}
{% from "macros/projects.html" import render_project_entry %}
{% from "macros/projects.html" import browse_to %}

{% block title %}{{ this.name }}{% endblock %}

{% block header %}

{% set project = site.get("/projects/" + this.path.split('/')[2]) %}
{{project_header_links(project, show_count=false)}}

{% set p = this.path.split('/') %}
<br>

<small>
{% for i in range(4,p|length+1) %}
  {% set ancestor = site.get(p[:i]|join('/')) %}
  <a style="margin-left:{{loop.index0}}rem;" href="{{ancestor|url}}">&boxur;<span class="active">{{ancestor.name}}</span></a>
  {% for item in ancestor.parent.children %}
    {% if item._model == 'folder' and item != ancestor %}
      <a class="lightgray" href="{{item|url}}">{{item.name}}</a>
    {% endif %}
  {% endfor %}
  <br>
{% endfor %}

{% if this.children.filter(F._model == 'folder') %}
  <span style="margin-left:{{p|length-3}}rem;" class="lightgray">
  &boxur;
  {% for item in this.children %}
    {% if item._model == 'folder' %}
      <a class="lightgray" href="{{item|url}}">{{item.name}}</a>
    {% endif %}
  {% endfor %}
  </span>
{% endif %}

</small>

{% endblock %}



{% block body %}

<script>
function createEntry(path, projectdate) {
    $.ajax({
        type: 'POST',
        dataType: 'json',
        contentType: 'application/json',
        processData: false,
        url: "/admin/api/newrecord",
        data: JSON.stringify({"id":projectdate,
                              "path":path,
                              "data":{"_model":"entry",
                                      "date":projectdate}})
    });
    location.reload();
}

function createFolder(path, foldername) {
    $.ajax({
        type: 'POST',
        dataType: 'json',
        contentType: 'application/json',
        processData: false,
        url: "/admin/api/newrecord",
        data: JSON.stringify({"id":foldername,
                              "path":path,
                              "data":{"_model":"folder",
                                      "date":new Date().toISOString().substring(0, 10),
                                      "name":foldername}})
    });
    location.reload();
}

</script>

{% set project = site.get("/projects/" + this.path.split('/')[2]) %}

<div class="row">
  <div class="six columns">
    <h1 style="display:inline-block;" class="orange">{{project.name}}/</h1>
    <h2 style="display:inline-block;" class="green">{{this.path.split('/')[3:]|join('/')}}</h2>
    {{ this.description }}
  </div>
  <div class="one column">
    {{browse_to(this)}}
  </div>
  <div class="three columns">
    <input id="date" type="date"> <a href="#" onclick="createEntry('{{this.path}}', document.querySelector('#date').value );">+</a>
    </small>
  </div>
</div>

<div class="row">
  <div class="ten columns">
    <span style="margin-left:{{this.path[2:]|length*0.8}}rem; color:#4daf4a;">&boxur;</span><input id="newfolder" class="newfolder" type="text" placeholder="new">
    <a href="#" class="green" onclick="createFolder('{{this.path}}', document.querySelector('#newfolder').value );">+</a>
  </div>
</div>

{% for item in this.children recursive %}
  {% if item._model != 'entry' %}
    <div class="row">
      <div class="two columns">
        {{browse_to(item)}}
        {% if item._model == 'project' %}
          {% set spanclass = 'orange' %}
        {% elif item._model == 'folder' %}
          {% set spanclass = 'green' %}
        {% endif %}
        <a style="margin-left:{{loop.depth0 * 2}}rem;" href="{{ item|url }}">&boxur;<span class="{{spanclass}}">{{ item.name }}</span></a>
      </div>
      <div class="nine columns">
        <small>
        {% set yyyy = 1900 %}
        {% set mm = 0 %}
        {% for entry in item.children.filter(F._model=='entry')|sort(attribute='date') %}
          {% if entry.date.year > yyyy %}
            <span class="gray">{{entry.date.year}}</span>
            {% set yyyy = entry.date.year %}
            {% set mm = 0 %}
          {% endif %}
          {% if entry.date.month > mm %}
            <span class="lightgray">{{entry.date.strftime('%b')}}</span>
            {% set mm = entry.date.month %}
          {% endif %}
          <a href="{{entry.parent|url}}#{{entry.date}}">{{entry.date.strftime('%e')}}</a>
        {% endfor %}
      </small> <a href="#" onclick="createEntry('{{item.path}}', document.querySelector('#date').value );">+</a></li>
      </div>
    </div>

  {{loop(item.children)}}

  {% endif %}
{% endfor %}




<div class="row">
  <div class="nine columns">
    <small>
    {% set yyyy = 1900 %}
    {% set mm = 0 %}
    {% for entry in this.children.filter(F._model=='entry')|sort(attribute='date') %}
      {% if entry.date.year > yyyy %}
        <span class="gray">{{entry.date.year}}</span>
        {% set yyyy = entry.date.year %}
        {% set mm = 0 %}
      {% endif %}
      {% if entry.date.month > mm %}
        <span class="lightgray">{{entry.date.strftime('%b')}}</span>
        {% set mm = entry.date.month %}
      {% endif %}
      <a href="{{entry.parent|url}}#{{entry.date}}">{{entry.date.strftime('%e')}}</a>
    {% endfor %}
  </small> <a href="#" onclick="createEntry('{{this.path}}', document.querySelector('#date').value );">+</a></li>
  </div>
</div>

<hr>

{% for entry in this.children %}
  {% if entry._model == 'entry' %}
    {{render_project_entry(entry)}}
  {% endif %}
{% endfor %}


<script>
(function () {
    var date = new Date().toISOString().substring(0, 10),
        field = document.querySelector('#date');
    field.value = date;
    console.log(field.value);

})()
</script>

{% endblock %}
